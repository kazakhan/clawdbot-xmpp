================================================================================
OPENCLAW CLI PLUGIN FIX - 2026.02.05
================================================================================

This patch fixes two issues:
1. XMPP plugin commands not available via `openclaw xmpp ...`
2. XMPP JIDs (user@domain) not recognized as valid targets

FILES TO PATCH:
- dist/cli/program/register.subclis.js
- dist/infra/outbound/target-resolver.js

LOCATION: Your openclaw installation
- Windows: C:\Users\Jordan\AppData\Roaming\npm\node_modules\openclaw\dist\

================================================================================
PATCH 1: register.subclis.js - Add plugin registration for channels
================================================================================

Find this section (around lines 194-201):

  {
    name: "channels",
    description: "Channel management",
    register: async (program) => {
      const mod = await import("../channels-cli.js");
      mod.registerChannelsCli(program);
    },
  },

Replace with:

  {
    name: "channels",
    description: "Channel management",
    register: async (program) => {
      const mod = await import("../channels-cli.js");
      mod.registerChannelsCli(program);
      // Register plugin CLI commands so channels like 'xmpp' work
      const { registerPluginCliCommands } = await import("../../plugins/cli.js");
      registerPluginCliCommands(program, await loadConfig());
    },
  },

================================================================================
PATCH 2: register.subclis.js - Make async and call registerPluginCliCommands
================================================================================

Find the registerSubCliCommands function (around lines 292-310):

export function registerSubCliCommands(program: Command, argv: string[] = process.argv) {
  if (shouldEagerRegisterSubcommands(argv)) {
    for (const entry of entries) {
      void entry.register(program);
    }
    return;
  }
  const primary = getPrimaryCommand(argv);
  if (primary && shouldRegisterPrimaryOnly(argv)) {
    const entry = entries.find((candidate) => candidate.name === primary);
    if (entry) {
      registerLazyCommand(program, entry);
      return;
    }
  }
  for (const candidate of entries) {
    registerLazyCommand(program, candidate);
  }
}

Replace with:

export async function registerSubCliCommands(program: Command, argv: string[] = process.argv) {
  if (shouldEagerRegisterSubcommands(argv)) {
    for (const entry of entries) {
      void entry.register(program);
    }
    return;
  }
  const primary = getPrimaryCommand(argv);
  if (primary && shouldRegisterPrimaryOnly(argv)) {
    const entry = entries.find((candidate) => candidate.name === primary);
    if (entry) {
      registerLazyCommand(program, entry);
      return;
    }
  }
  for (const candidate of entries) {
    registerLazyCommand(program, candidate);
  }
  // Register plugin CLI commands for lazy-loaded subcommands
  const { registerPluginCliCommands } = await import("../../plugins/cli.js");
  registerPluginCliCommands(program, await loadConfig());
}

================================================================================
PATCH 3: target-resolver.js - Add XMPP JID pattern recognition
================================================================================

Find the looksLikeTargetId function (around line 375-378):

    if (/^(conversation|user):/i.test(trimmed)) {
      return true;
    }
    return false;

Replace with:

    if (/^(conversation|user):/i.test(trimmed)) {
      return true;
    }
    // XMPP JID pattern: user@domain format (e.g., jamie@kazakhan.com)
    if (/^[a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(trimmed)) {
      return true;
    }
    return false;

================================================================================
VERIFICATION
================================================================================

After applying patches:

1. Restart openclaw gateway:
   openclaw gateway stop
   openclaw gateway

2. Test XMPP plugin commands:
   openclaw xmpp --help
   # Should show: msg, roster, nick, join, poll, etc.

3. Test JID target resolution:
   openclaw xmpp status
   # Should connect and show status

4. Send test message:
   openclaw xmpp msg jamie@kazakhan.com "Test"
   # Should NOT show "Unknown target" error

================================================================================
ROLLBACK
================================================================================

If something breaks:
1. Delete the patched files
2. Run: npm install -g openclaw@latest
3. Reapply only patches 1 and 3 (skip patch 2 if source is sync again)

================================================================================
